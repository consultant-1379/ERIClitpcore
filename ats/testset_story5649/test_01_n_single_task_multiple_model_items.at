# Test Case 01.

# Description:
#   Given a LITP deployment and a LITP plugin, where one task is generated by
#   the plugin, if a list of multiple model items is associated with the task
#   and the task execution fails, then none of the model item's states will be
#   updated.
# Expected result:
#   After the task execution fails, the model items' states are unchanged.


# Prerequisite - story5649 extension and plugin
add-extensions extensions/story5649_extension
add-plugins plugins/story5649_plugin

# Prerequisite - LITP Deployment
litp create -p /software/items/telnet -t mock-package -o name=telnet
litp create -p /software/items/gcc -t mock-package -o name=gcc
litp create -p /software/items/vim -t mock-package -o name=vim

litp inherit -p /ms/items/telnet -s /software/items/telnet
litp inherit -p /ms/items/gcc -s /software/items/gcc
litp inherit -p /ms/items/vim -s /software/items/vim

litp create_plan
litp run_plan

litp update -p /software/items/telnet -o name=telnet_updated
litp update -p /software/items/gcc -o name=gcc_updated
litp update -p /software/items/vim -o name=vim_updated

# 1. Create a story5649 item with extra items associated
litp create -p /software/items/item_01 -t story5649 -o name=item_01 extra_items=telnet,gcc

# 2. Check the state of the items before running the plan
assertState -p /software/items/item_01 Initial

assertState -p /ms/items/telnet Updated
assertAppliedPropertiesDeterminable -p /ms/items/telnet True

assertState -p /ms/items/gcc Updated
assertAppliedPropertiesDeterminable -p /ms/items/gcc True

assertState -p /ms/items/vim Updated
assertAppliedPropertiesDeterminable -p /ms/items/vim True

# 3. Create the plan and make the item_01 task fail
litp create_plan
assertPlanState initial

failCallbackTask cb_success_1 /software/items/item_01

litp run_plan
assertPlanState failed

# 4. Check that the state of the items associated to the task did not change
#    and their APD flag is set to False after the task failed
assertState -p /software/items/item_01 Initial
assertAppliedPropertiesDeterminable -p /software/items/item_01 False

assertState -p /ms/items/telnet Updated
assertAppliedPropertiesDeterminable -p /ms/items/telnet False

assertState -p /ms/items/gcc Updated
assertAppliedPropertiesDeterminable -p /ms/items/gcc False

assertState -p /ms/items/vim Updated
assertAppliedPropertiesDeterminable -p /ms/items/vim True

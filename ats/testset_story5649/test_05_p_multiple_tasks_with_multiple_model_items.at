# Test Case 05.

# Description:
#   Given a LITP deployment and a LITP plugin, where multiple tasks are
#   generated by the plugin, if a list of multiple model items is associated
#   with those tasks and all tasks' executions succeed, then the model items
#   will be set to an Applied state, if and only if all associated tasks
#   succeed.
# Expected results:
#   The model items associated with the successful tasks will be set to an
#   Applied state while the model items associated with the failed tasks will
#   remain in an unchanged state.


# Prerequisite - story5649 extension and plugin
add-extensions extensions/story5649_extension
add-plugins plugins/story5649_plugin

# Prerequisite - LITP Deployment
litp create -p /software/items/telnet -t mock-package -o name=telnet
litp create -p /software/items/gcc -t mock-package -o name=gcc
litp create -p /software/items/vim -t mock-package -o name=vim
litp create -p /software/items/wget -t mock-package -o name=wget

litp inherit -p /ms/items/telnet -s /software/items/telnet
litp inherit -p /ms/items/gcc -s /software/items/gcc
litp inherit -p /ms/items/vim -s /software/items/vim
litp inherit -p /ms/items/wget -s /software/items/wget

litp create_plan
litp run_plan

litp update -p /software/items/telnet -o name=telnet_updated
litp update -p /software/items/gcc -o name=gcc_updated
litp update -p /software/items/vim -o name=vim_updated
litp update -p /software/items/wget -o name=wget_updated

# 1. Create two story5649 items with extra items associated
litp create -p /software/items/item_01 -t story5649 -o name=item_01 extra_items=telnet,gcc,vim,wget

litp create -p /software/items/item_02 -t story5649 -o name=item_02 extra_items=vim,wget

# 2. Check the state of the items before running the plan
assertState -p /ms/items/telnet Updated
assertState -p /ms/items/gcc Updated
assertState -p /ms/items/vim Updated
assertState -p /ms/items/wget Updated

# 3. Create the plan and make one of the tasks fail
litp create_plan
assertPlanState initial

failCallbackTask cb_success_1 /software/items/item_02

litp run_plan
assertPlanState failed

# 4. Check the state of the items after running the plan
assertState -p /software/items/item_01 Applied
assertAppliedPropertiesDeterminable -p /software/items/item_01 True

assertState -p /software/items/item_02 Initial
assertAppliedPropertiesDeterminable -p /software/items/item_02 False

assertState -p /ms/items/telnet Updated
assertAppliedPropertiesDeterminable -p /ms/items/telnet False

assertState -p /ms/items/gcc Updated
assertAppliedPropertiesDeterminable -p /ms/items/gcc False

assertState -p /ms/items/vim Updated
assertAppliedPropertiesDeterminable -p /ms/items/vim False

assertState -p /ms/items/wget Updated
assertAppliedPropertiesDeterminable -p /ms/items/wget False
